<!DOCTYPE html>
<html th:replace="layouts/main::main(~{::div}, ~{::script}, ~{::link})">

<link th:href="@{/assets/css/fancybox.css}" rel="stylesheet" type="text/css"/>
<div class="content">
    <div class="container">
        <div class="row">
            <div class="row">
                <div class="col-sm-4 col-lg-4 col-xs-12 item" th:each="camera, iterStat : ${cameras}"
                     th:id="${'item' + camera.id}" th:attr="data-id=${camera.id},data-url=${camera.snapshotUrl}">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-secondary move-left">
                                    <span> <i class="mdi mdi-arrow-left"></i></span>
                                </button>
                                <button type="button" class="btn btn-secondary move-right">
                                    <span><i class="mdi mdi-arrow-right"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card m-b-10">
                        <div class="card-block">
                            <span class="badge"
                                  th:class="${'IN'.equals(camera.gate.gateType.toString()) ? 'badge badge-primary' : 'badge badge-success'}"
                                  th:text="${camera.gate.gateType}">
                            </span>
                            <h5 class="mt-0 card-title" th:text="${camera.name}"></h5>
                            <h6 class="card-subtitle text-muted" th:text="${camera.gate.name}"></h6>
                        </div>
                        <div class="row" style="position: relative">
                            <a class="col col--4" th:id="${'fancyImage' + camera.id}" data-fancybox="event"
                               style="height: 250px!important;"
                               th:data-src="@{#{arm.noImageLink}}" th:data-caption="#{arm.noData}">
                                <img th:id="${'image' + camera.id}" class="img-fluid m-b-10"
                                     th:src="@{#{arm.noImageLink}}" style="height: 250px !important;"
                                     alt="Card image cap">
                            </a>
                            <div class="align-content-center p-1"
                                 style="background-color: rgba(74, 82, 95, .5); position: absolute; bottom: 0;right: 10px;display: none">
                                <img th:id="${'lp' + camera.id}"/>
                            </div>
                        </div>
                        <table class="w-100">
                            <tbody>
                            <tr>
                                <td class="w-50"
                                    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                    <button type="button" class="btn btn-outline-success w-100"
                                            th:cameraId="${camera.id}"
                                            th:onclick="openGate(this.getAttribute('cameraId'))"
                                            th:text="#{arm.open}"></button>
                                </td>
                                <td class="w-50"
                                    sec:authorize="!hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                </td>
                                <td class="w-50"
                                    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                    <button type="button" class="btn btn-outline-warning w-100"
                                            th:cameraId="${camera.id}"
                                            th:onclick="closeGate(this.getAttribute('cameraId'))"
                                            th:text="#{arm.close}"></button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <table class="w-100">
                            <tbody>
                            <tr>
                                <td class="w-50"
                                    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                    <input type="text" th:id="${'plateNumber' + camera.id}" th:cameraId="${camera.id}"
                                           th:placeholder="#{arm.licensePlate}"
                                           th:onkeydown="onTextEnter(this.getAttribute('cameraId'))"
                                           class="form-control w-100">
                                </td>
                                <td class="w-25"
                                    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                    <button type="button" class="btn btn-outline-info w-100" th:cameraId="${camera.id}"
                                            th:onclick="passCar(this.getAttribute('cameraId'))"
                                            th:text="#{crm.letIn}"></button>
                                </td>
                                <td class="w-25"
                                    sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_SUPERADMIN','ROLE_OPERATOR')">
                                    <button type="button" class="btn btn-outline-primary w-100"
                                            th:cameraId="${camera.id}"
                                            th:onclick="checkBalance(this.getAttribute('cameraId'))"
                                            th:text="#{crm.balance}"></button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <textarea class="m-b-10 border border-dark" style="width: 100%" rows="3"
                              th:id="${'logs' + camera.id}"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/assets/js/sockjs.js}"></script>
<script th:src="@{/assets/js/stomp.js}"></script>
<script th:src="@{/assets/js/fancybox.umd.js}"></script>

<script th:inline="javascript">
    var locale = [[${#locale}]];
    var img;

    jQuery('.move-left').click(function (e) {
        var $div = $(this).closest('.item');
        $div.prev('.item').before($div);
    })

    jQuery('.move-right').click(function (e) {
        var $div = $(this).closest('.item');
        $div.next('.item').after($div);
    })

    var recInterval = null;
    var socket = null;

    function connect() {
        console.log('Web socket initializing');
        socket = new WebSocket((window.location.protocol.indexOf('https') !== -1 ? 'wss' : 'ws') + '://' + window.location.host + '/greeting');
        ws = Stomp.over(socket);

        ws.connect({}, function (frame) {
            console.log('Web socket connecting');
            ws.subscribe("/topic", function (message) {
                const messageBody = JSON.parse(message.body);
                showGreeting(messageBody);
            });
        }, function (error) {
            console.log("STOMP error " + error);
        });

        console.log('Interval clearing');
        clearInterval(recInterval);

        socket.onclose = function() {
            console.log('Web closed');
            socket = null;
            recInterval = setInterval(function() { connect(); }, 2000);
        };
        console.log('##################');
    }

    function showGreeting(messageBody) {
        var logMessage = locale == "en" ? messageBody.messageEng : messageBody.message;
        if (messageBody.eventType == 'Photo') {
            img = messageBody.message.indexOf('data:image/jpg;base64,') !== -1 ? messageBody.message : 'data:image/jpg;base64,' + messageBody.message;
            $("#image" + messageBody.id).attr("src", img);
            $("#fancyImage" + messageBody.id).attr("data-src", img);
        } else if (messageBody.eventType == 'CarEvent') {
            $("#logs" + messageBody.id).prepend('[' + messageBody.plateNumber + ']' + logMessage + "\n");
            $("#fancyImage" + messageBody.id).attr("data-caption", messageBody.plateNumber);
        } else if (messageBody.eventType == 'Lp' && messageBody.message) {
            $("#lp" + messageBody.id).parent().show();
            $("#lp" + messageBody.id).attr("src", messageBody.message.indexOf('data:image/jpg;base64,') !== -1 ? messageBody.message : 'data:image/jpg;base64,' + messageBody.message);
        } else {
            console.log('Unknown event type ' + messageBody);
        }

        switch (messageBody.eventStatus) {
            case "Allow":
            case "Success":
                $("#logs" + messageBody.id)
                    .removeClass("border-dark")
                    .removeClass("border-danger")
                    .addClass("border-success");
                break;
            case "Deny":
            case "Error":
                $("#logs" + messageBody.id)
                    .removeClass("border-dark")
                    .removeClass("border-success")
                    .addClass("border-danger");
                break;
        }
    }

    $(function () {
        connect();
    });

    $(document).ready(function() {
        $(".item").each(function () {
            const $input = $(this);
            const $id = $input.data("id");
            const $url = $input.data("url");
            if ($url && $url !== "") {
                var d= new Date();
                $.get("/rest/arm/enable/" + $id+"?ver="+d.getTime(), function (data) {
                    console.log(data);
                });
            }
        })

        $(window).unload(function() {
            $.get("/rest/arm/disable", function (data) {
                console.log(data);
            });
        });
    });

    window.addEventListener("beforeunload", function (e) {
        $.get("/rest/arm/disable", function (data) {
            console.log(data);
        });
        e.preventDefault();
        e.returnValue = "";
    });

    function openGate(cameraId) {
        $.get("/rest/arm/open/" + cameraId, function (data) {
            console.log(data);
        });
    }

    function closeGate(cameraId) {
        $.get("/rest/arm/close/" + cameraId, function (data) {
            console.log(data);
        });
    }

    function onTextEnter(cameraId) {
        if (event.keyCode === 13) {
            passCar(cameraId);
        }
    }

    function passCar(cameraId) {
        var plateNumber = $("#plateNumber" + cameraId).val();
        if (plateNumber && plateNumber.length > 2 && plateNumber.length < 17) {
            var form = new FormData();
            form.append("cameraId", cameraId);
            form.append("platenumber", plateNumber);
            form.append("snapshot", img);

            var settings = {
                "url": "/rest/arm/pass",
                "method": "POST",
                "timeout": 0,
                "processData": false,
                "contentType": false,
                "data": form
            };
            $.ajax(settings).done(function (response) {
                console.log(response);
            });

            /*$.get("/rest/arm/pass/" + cameraId + "/platenumber/" + plateNumber, function (data) {
                console.log(data);
            });*/
        } else {
            alert([[#{arm.invalidPlateNumber}]]);
        }
    }

    function checkBalance(cameraId) {
        var plateNumber = $("#plateNumber" + cameraId).val();
        if (plateNumber && plateNumber.length > 2 && plateNumber.length < 17) {
            $.get("/rest/balance/check/" + plateNumber, function (data) {
                alert([[#{arm.balanceEqual}]] + data);
            });
        } else {
            alert([[#{arm.invalidPlateNumber}]]);
        }
    }
</script>
</html>
