<!DOCTYPE html>
<html th:replace="layouts/main::main(~{::div}, ~{::script}, ~{::link})" xmlns="http://www.w3.org/1999/html">

<link th:href="@{/plugins/datatables/dataTables.bootstrap4.min.css}" rel="stylesheet" type="text/css"/>
<link th:href="@{/plugins/datatables/buttons.bootstrap4.min.css}" rel="stylesheet" type="text/css"/>
<link th:href="@{/plugins/datatables/responsive.bootstrap4.min.css}" rel="stylesheet" type="text/css"/>

<div class="content">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card table-responsive">
                    <div class="card-header" th:text="#{report.billing}"></div>
                    <div class="card-body" id="main">
                        <div>
                            <form method="post">
                                <div class="form-row">
                                    <div class="col-4">
                                        <input id="dateFrom" type="datetime-local" class="form-control" />
                                    </div>
                                    <div class="col-4">
                                        <input id="dateTo" type="datetime-local" class="form-control" />
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="btn btn-primary mr-1"
                                                onclick="find()"
                                                th:text="#{report.find}"></button>
                                    </div>
                                    <div class="col-1">
                                        <button type="button" class="btn btn-primary mr-1"
                                                onclick="clear()"
                                                th:text="#{report.clear}"></button>
                                    </div>
                                    <div class="col-2">
                                        <button type="button" class="btn btn-success mr-1"
                                                onclick="excel()"
                                                th:text="#{report.excel}"></button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="mb-5"></div>
                        <table id="sumReport" class="table table-bordered table-striped dataTable no-footer">
                        </table>
                    </div>
                    <div class="card-body" id="detailed">
                        <div>
                            <form method="post">
                                <div class="form-row">
                                    <div class="col-1">
                                        <button type="button" class="btn btn-primary mr-1"
                                                onclick="back()"
                                                th:text="#{crm.back}"></button>
                                    </div>
                                    <div class="col-2">
                                        <button type="button" class="btn btn-success mr-1"
                                                onclick="excelDetailed()"
                                                th:text="#{report.excel}"></button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="mb-5"></div>
                        <table id="sumDetailed" class="table table-bordered table-striped dataTable no-footer">
                            <thead>
                                <tr>
                                    <th>Номер авто</th>
                                    <th>Дата въезда</th>
                                    <th>Дата выезда</th>
                                    <th>Место въезда</th>
                                    <th>Место выезда</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Required datatable js -->
<script th:src="@{/plugins/datatables/jquery.dataTables.min.js}"></script>
<script th:src="@{/plugins/datatables/dataTables.bootstrap4.min.js}"></script>
<!-- Buttons examples -->
<script th:src="@{/plugins/datatables/dataTables.buttons.min.js}"></script>
<script th:src="@{/plugins/datatables/buttons.bootstrap4.min.js}"></script>
<script th:src="@{/plugins/datatables/jszip.min.js}"></script>
<script th:src="@{/plugins/datatables/pdfmake.min.js}"></script>
<script th:src="@{/plugins/datatables/vfs_fonts.js}"></script>
<script th:src="@{/plugins/datatables/buttons.html5.min.js}"></script>
<script th:src="@{/plugins/datatables/buttons.print.min.js}"></script>
<script th:src="@{/plugins/datatables/buttons.colVis.min.js}"></script>
<!-- Responsive examples -->
<script th:src="@{/plugins/datatables/dataTables.responsive.min.js}"></script>
<script th:src="@{/plugins/datatables/responsive.bootstrap4.min.js}"></script>
<script th:src="@{/assets/js/xlsx.js}"></script>

<script th:inline="javascript">
    let date=new Date();
    let dateFrom = (new Date(date.getFullYear(),date.getMonth(),date.getDate(), 6, 0, 0, 0)).toISOString();
    let dateTo = (new Date(date.getFullYear(),date.getMonth(),date.getDate(), date.getHours()+6, date.getMinutes())).toISOString();
    $('#dateFrom').val(dateFrom.substring(0, dateFrom.length-1));
    $('#dateTo').val(dateTo.substring(0, dateTo.length-1));

    var globalDateFrom = $('#dateFrom').val();
    var globalDateTo = $('#dateTo').val();

    function find() {
        globalDateFrom = $('#dateFrom').val();
        globalDateTo = $('#dateTo').val();
        let request = {
            "dateFrom": globalDateFrom,
            "dateTo": globalDateTo
        };

        let predefinedFields = ['dateTime','records','inDateCount','paymentRecords','whitelistRecords','abonementRecords','freeMinuteRecords','debtRecords','fromBalanceRecords','freeRecords','autoClosedRecords'];
        let hasLinkFileds = ['paymentRecords','whitelistRecords','abonementRecords','freeMinuteRecords','debtRecords','fromBalanceRecords','freeRecords','autoClosedRecords'];

        $.ajax({
            url: "/rest/report/sum/excel",
            type: "POST",
            data: JSON.stringify(request),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                let html = '<thead><tr>';
                $.each(predefinedFields, function(value) {
                    html = html + '<td>' + data[0].fields[predefinedFields[value]] + '</td>';
                });
                if(data[0].fields['bankCardSum']){
                    html = html + '<td>' + data[0].fields['bankCardSum'] + '</td>';
                    predefinedFields.push('bankCardSum');
                }
                if(data[0].fields['cashSum']){
                    html = html + '<td>' + data[0].fields['cashSum'] + '</td>';
                    predefinedFields.push('cashSum');
                }
                $.each(data[0].fields, function( key, value ) {
                    if(predefinedFields.indexOf(key) === -1 && key !== 'totalSum'){
                        html = html + '<td>' + value + '</td>';
                        predefinedFields.push(key);
                    }
                });
                html = html + '<td>' + data[0].fields['totalSum'] + '</td></tr></thead>';
                predefinedFields.push('totalSum');

                if(data.length > 1){
                    html = html + '<tbody>';
                    let i = 0;
                    $.each(data, function(result) {
                        if(i++ > 0){
                            html = html + '<tr>';
                            $.each(predefinedFields, function(value) {
                                html = html + '<td>';
                                if(hasLinkFileds.indexOf(predefinedFields[value]) !== -1 && data[result].results[predefinedFields[value]]){
                                    html = html +  "<a href='#' onclick='openList(\""+predefinedFields[value]+ "\",\"" + data[result].results['date'] + "\")'>";
                                }
                                html = html + (data[result].results[predefinedFields[value]] ? data[result].results[predefinedFields[value]] : 0);
                                if(value !== 'dateTime'){
                                    html = html +  '</a>';
                                }
                                html = html + '</td>';
                            });
                            html = html + '</tr>';
                        }
                    });
                    html = html + '</tbody>';
                }
                $('#sumReport').html(html);
            }
        })
    }

    function clear() {
        $('#dateFrom').val(dateFrom.substring(0, dateFrom.length-1));
        $('#dateTo').val(dateTo.substring(0, dateTo.length-1));
    }

    $(document).on('ready',function(){
        find();
    });

    function excel() {
        const wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(document.getElementById("sumReport"));
        XLSX.utils.book_append_sheet(wb, ws, 'billing');
        XLSX.writeFile(wb, "billing.xlsx", { type: "buffer" });
    }

    function openList(val, date){
        let request = {
            "dateFrom": globalDateFrom,
            "dateTo": globalDateTo,
            "eventType": val,
            "date": date,
            "type": "detailed"
        };

        $('#main').hide();
        $('#detailed').show();

        $.ajax({
            url: "/rest/report/sum/excel",
            type: "POST",
            data: JSON.stringify(request),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data);
                let html = '';
                $.each(data, function(result) {
                    html = html + '<tr>';
                    html = html + '<td>' + data[result].listResult.plateNumber + '</td>'
                        + '<td>' + data[result].listResult.formattedInDate + '</td>'
                        + '<td>' + data[result].listResult.formattedOutDate + '</td>'
                        + '<td>' + data[result].listResult.inPlace + '</td>'
                        + '<td>' + (data[result].listResult.outPlace ? data[result].listResult.outPlace : '' ) + '</td>';
                    html = html + '</tr>';
                });
                $('#sumDetailed>tbody').html(html);
            }
        });
    }

    function excelDetailed() {
        const wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(document.getElementById("sumDetailed"));
        XLSX.utils.book_append_sheet(wb, ws, 'detailed');
        XLSX.writeFile(wb, "detailed.xlsx", { type: "buffer" });
    }

    function back() {
        $('#main').show();
        $('#detailed').hide();
    }
</script>

</html>